flowchart TD
    A([Start]) --> B[Parse CLI args]
    B --> C{Input DB exists?}
    C -- No --> Z1([Abort with error])
    C -- Yes --> D[Resolve output DB/JSON/log paths]
    D --> E[Open source DB and output DB]
    E --> F[Create output schema]
    F --> G[Load pair profiles]
    G --> H{Any pairs?}
    H -- No --> H1[Write empty run metadata]
    H1 --> H2{DQ enabled?}
    H2 -- Yes --> H3[Write DQ summary tables]
    H2 -- No --> H4[Skip DQ tables]
    H3 --> H5[Export run JSON]
    H4 --> H5
    H5 --> H6([End])

    H -- Yes --> I{workers > 1?}
    I -- No --> J[Process pairs sequentially]
    I -- Yes --> K[Spawn workers and queue]
    K --> L[Workers emit chunks + summaries]
    L --> M[Single writer inserts chunks]
    M --> N[Collect all pair summaries]
    J --> N

    N --> O[Write cleansing_pair_summary]
    O --> P{DQ enabled?}
    P -- Yes --> Q[Run DQ checks and write DQ tables]
    P -- No --> R[Skip DQ checks]
    Q --> S[Write cleansing_run_metadata]
    R --> S
    S --> T[Export run JSON]
    T --> U[Write final logs]
    U --> V([End])
