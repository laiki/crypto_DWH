flowchart TD
    A([Start]) --> B[Parse CLI arguments]
    B --> C{Input mode valid?}
    C -- No --> C1[Emit usage/input error]
    C1 --> Z1([Exit code 1])
    C -- Yes --> D[Resolve staging/cleansing paths]
    D --> E{All input files exist?}
    E -- No --> E1[Emit file-not-found error]
    E1 --> Z1
    E -- Yes --> F[Open SQLite in-memory session]
    F --> G[Attach staging_src and cleansing_src]
    G --> H[Check required source tables]
    H --> I{Missing tables?}
    I -- Yes --> I1[Set error_message]
    I1 --> R[Write JSON + Markdown report]
    I -- No --> J[Create TEMP alias views]
    J --> J1{Scope options set?}
    J1 -- Yes --> J2[Apply --kpi-date and/or --cleansing-run-id filters]
    J1 -- No --> K[Use full source scope]
    J2 --> K
    K --> L[Apply core_kpi_views.sql as TEMP views]
    L --> M[Execute core_kpi_assertions.sql]
    M --> N{Skip view row counts?}
    N -- No --> O[Compute COUNT(*) for all KPI views]
    N -- Yes --> P[Skip COUNT(*) block]
    O --> R
    P --> R
    R --> S{Execution error occurred?}
    S -- Yes --> T([Exit code 1])
    S -- No --> U{fail_on_error and error_failed > 0?}
    U -- Yes --> V([Exit code 2])
    U -- No --> W([Exit code 0])
